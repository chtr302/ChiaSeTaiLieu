<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/head :: head('Studucu - Library')}"></head>
<body class="library">
    <div class="nav" th:replace="~{fragments/navbar :: navbar(sinhVien=${sinhVien != null ? sinhVien : null})}"></div>
    <div class="main">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
          <div class="sidebar-padding"></div>
          <div class="sidebar-content">
            <div class="sidebar-header">
              <div class="user-profile" id="user-profile">
                <a th:href="@{/library}" class="user-profile-link">
                  <img class="avatar" th:src="${sinhVien != null ? sinhVien.hinhAnh : ''}" th:alt="${sinhVien != null ? sinhVien.hoVaTen : 'User'}" 
                       onerror="this.src='/img/default-avatar.png'">
                  <div class="user-info">
                    <p class="username" th:text="${sinhVien != null ? sinhVien.hoVaTen : 'User'}">Username</p>
                  </div>
                </a>
              </div>
              <button id="upload-btn" class="upload-button">
                <i class="fas fa-cloud-upload-alt"></i> Upload Document
              </button>
            </div>
            <ul class="sidebar-menu">
              <li class="sidebar-item" th:classappend="${#httpServletRequest != null && #httpServletRequest.getRequestURI() == '/index' ? 'active' : ''}">
                <a th:href="@{/index}">
                    <i class="fas fa-home"></i> Home
                </a>
              </li>
              <li class="sidebar-item" th:classappend="${#httpServletRequest != null && #httpServletRequest.getRequestURI() != null && #httpServletRequest.getRequestURI().contains('/courses') ? 'active' : ''}">
                <a th:href="@{/documents/courses}">
                  <i class="fas fa-book"></i> Courses
                </a>
              </li>
              <li class="sidebar-item active" th:classappend="${#httpServletRequest != null && #httpServletRequest.getRequestURI() != null && #httpServletRequest.getRequestURI().contains('/library') ? 'active' : ''}">
                <a th:href="@{/library}">
                  <i class="fas fa-folder-open"></i> Library
                </a>
              </li>
              <li class="sidebar-item dropdown" id="recents-dropdown">
                <a href="javascript:void(0);">
                  <i class="fas fa-clock"></i> Recents
                  <i class="fas fa-chevron-down dropdown-icon"></i>
                </a>
                <div class="dropdown-content" id="recents-dropdown-content">
                  <!-- Will be populated with JavaScript -->
                </div>
              </li>
            </ul>
          </div>
        </div>

        <main class="main-content">
            <!-- Popup Library Info (shown when clicked from profile) -->
            <div id="library-popup" class="library-popup">
                <div class="library-popup-content">
                    <div class="library-popup-header">
                        <h3>My Library</h3>
                        <button id="close-library-popup" class="close-library-popup">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="library-popup-body">
                        <div class="library-stats">
                            <div class="library-stat-item">
                                <span class="stat-number" th:text="${uploadCount != null ? uploadCount : '0'}">4</span>
                                <span class="stat-label">Uploaded</span>
                            </div>
                            <div class="library-stat-item">
                                <span class="stat-number">15</span>
                                <span class="stat-label">Saved</span>
                            </div>
                            <div class="library-stat-item">
                                <span class="stat-number">89</span>
                                <span class="stat-label">Total Documents</span>
                            </div>
                        </div>
                        <div class="library-actions">
                            <button class="btn-primary">
                                <i class="fas fa-upload"></i> Upload
                            </button>
                            <button class="btn-secondary">
                                <i class="fas fa-folder"></i> Browse
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <section class="user-header-section">
                <img th:if="${sinhVien != null && sinhVien.hinhAnh != null}" th:src="${sinhVien.hinhAnh}" th:alt="${sinhVien.hoVaTen}" class="user-avatar-medium">
                <img th:unless="${sinhVien != null && sinhVien.hinhAnh != null}" src="/img/default-avatar.png" alt="Default avatar" class="user-avatar-medium">
                <div class="user-details">
                    <h2 class="user-name" th:text="${sinhVien != null ? sinhVien.hoVaTen : 'Guest'}">Username</h2>
                    <p class="user-major">
                        <i class="fas fa-university icon-major"></i>
                        <span>Ngành Công nghệ thông tin</span>
                    </p>
                    <div class="user-follow-stats">
                        <div class="follow-item">
                            <span class="follow-count">0</span>
                            <span class="follow-label">Followers</span>
                        </div>
                        <div class="follow-item">
                            <span class="follow-count">0</span>
                            <span class="follow-label">Following</span>
                        </div>
                    </div>
                </div>
            </section>

            <section class="statistics-section">
                <div class="stats-container">
                    <div class="stat-card uploads-card">
                        <div class="stat-card-header">
                            <i class="fas fa-file-alt icon-uploads"></i>
                            <h3>My Uploads</h3>
                        </div>
                        <div class="stat-card-values">
                            <div class="stat-item">
                                <span class="stat-number" th:text="${uploadCount != null ? uploadCount : '0'}">3</span>
                                <span class="stat-label">Uploads</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-number">0</span>
                                <span class="stat-label">Upvotes</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-number">0</span>
                                <span class="stat-label">Comments</span>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card impact-card">
                        <div class="stat-card-header">
                            <i class="fas fa-heart icon-impact"></i>
                            <h3>Impact</h3>
                        </div>
                        <div class="stat-card-values impact-values">
                            <div class="stat-item">
                                <span class="stat-number">0</span>
                                <span class="stat-label">Students Helped</span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section class="documents-section card">
                <div class="library-header">
                    <h2 class="library-title">My Library <span class="library-count">(89 documents)</span></h2>
                    <div class="library-filters">
                        <select class="filter-select">
                            <option>All Subjects</option>
                            <option>Economics</option>
                            <option>Marketing</option>
                            <option>Finance</option>
                        </select>
                        <select class="filter-select">
                            <option>Sort by: Recently Added</option>
                            <option>Sort by: Oldest</option>
                            <option>Sort by: Title</option>
                        </select>
                        <button class="btn btn-primary">Filter</button>
                    </div>
                </div>

                <div class="document-grid">
                  <div class="document-card" th:each="doc, docStat : ${Documents != null ? Documents : {}}" th:if="${docStat != null && docStat.index < 4}">
                    
                    <!-- Thumbnail -->
                    <img th:if="${doc != null && doc.thumbnail != null}" th:src="@{'/documents/thumbnails/' + ${doc.thumbnail}}" 
                         alt="Document Preview" class="document-image">
                    <img th:if="${doc == null || doc.thumbnail == null}" src="/img/default-document.png" 
                         alt="Document Preview" class="document-image">
                
                    <!-- Details -->
                    <div class="document-details">
                      <p class="document-title" th:text="${doc != null ? doc.tieuDe : 'Document Title'}">Document Title</p>
                      <div class="document-category">
                        <p>
                          <i class="fas fa-book"></i>
                          <span th:text="${doc != null && doc.tenMon != null ? doc.tenMon : 'Course'}">Course</span>
                        </p>
                        <p>
                          <i class="fas fa-folder"></i>
                          <span th:text="${doc != null && doc.tenLoai != null ? doc.tenLoai : 'Category'}">Category</span>
                        </p>
                      </div>
                      
                      <!-- Stats Row -->
                      <div class="document-stats-row">
                        <!-- Vote Section -->
                        <div class="vote-oval">
                          <button class="upvote-btn"><i class="fas fa-thumbs-up"></i></button>
                          <span class="vote-count" th:text="${doc != null && doc.danhGia != null ? doc.danhGia : '0'}">0</span>
                          <button class="downvote-btn"><i class="fas fa-thumbs-down"></i></button>
                        </div>
                
                        <!-- Views & Comments -->
                        <div class="view-comment-group">
                          <span class="views"><i class="fas fa-eye"></i> <span th:text="${doc != null && doc.luotXem != null ? doc.luotXem : '0'}">0</span></span>
                          <span class="comments"><i class="fas fa-comment"></i> <span th:text="${doc != null && doc.soLuongBL != null ? doc.soLuongBL : '0'}">0</span></span>
                        </div>
                      </div>
                
                      <!-- Action Buttons -->
                      <div class="document-buttons">
                        <a th:if="${doc != null && doc.maTaiLieu != null}" th:href="@{'/documents/detail/' + ${doc.maTaiLieu}}" class="view-btn">Xem</a>
                        <a th:if="${doc == null || doc.maTaiLieu == null}" href="#" class="view-btn">Xem</a>
                        <button class="save-btn">Lưu</button>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="load-more-container">
                    <button class="btn btn-secondary">Load more</button>
                </div>
            </section>
        </main>
    </div>
    
    <!-- Upload Modal -->
    <div id="upload-modal" class="modal-overlay">
      <div class="modal-container">
        <div class="modal-header">
          <h3 class="modal-title">Upload Document</h3>
          <button id="close-modal" class="modal-close"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body">
          <form id="upload-form" th:action="@{/documents/upload}" method="post" enctype="multipart/form-data">
            <div class="file-upload">
              <input type="file" id="file-input" name="file" class="file-input" accept=".pdf" required>
              <div class="upload-default">
                <i class="fas fa-cloud-upload-alt"></i>
                <p class="upload-title">Nhấp vào đây hoặc kéo thả file PDF</p>
                <p class="upload-description">Chỉ chấp nhận định dạng PDF (tối đa 50MB)</p>
              </div>
              <div class="file-preview" id="file-preview" style="display: none;"></div>
            </div>
            <div class="form-section">
              <div class="form-group">
                <label for="tieuDe" class="form-label">Title <span class="required">*</span></label>
                <input type="text" id="tieuDe" name="tieuDe" placeholder="Document title" class="form-control" required>
              </div>
              <div class="form-group">
                <label for="maLoai" class="form-label">Category <span class="required">*</span></label>
                <select id="maLoai" name="maLoai" class="form-control" required>
                  <option value="">Select a category</option>
                  <option th:each="category : ${loaiTaiLieu != null ? loaiTaiLieu : {}}"
                          th:value="${category != null && category.maLoai != null ? category.maLoai : ''}" 
                          th:text="${category != null && category.tenLoai != null ? category.tenLoai : 'Category Name'}">Category Name</option>
                </select>
              </div>
              <div class="form-group">
                <label for="maMonHoc" class="form-label">Course <span class="required">*</span></label>
                <select id="maMonHoc" name="maMonHoc" class="form-control" required>
                  <option value="">Select a course</option>
                  <option th:each="monHoc : ${danhSachMonHoc != null ? danhSachMonHoc : {}}"
                          th:value="${monHoc != null && monHoc.maMon != null ? monHoc.maMon : ''}" 
                          th:text="${monHoc != null && monHoc.tenMon != null ? monHoc.tenMon : 'Course Name'}">Course Name</option>
                </select>
              </div>
              <div class="form-group">
                <label for="tags" class="form-label">Tags</label>
                <input type="text" id="tags" name="tags" placeholder="e.g. python, ai, notes (separated by commas)" class="form-control">
              </div>
              <div class="form-group">
                <label for="moTa" class="form-label">Description <span class="required">*</span></label>
                <textarea id="moTa" name="moTa" rows="4" placeholder="Describe your document" class="form-control" required></textarea>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" id="cancel-upload" class="btn-cancel">Cancel</button>
              <button type="submit" id="save-upload" class="btn-save"><i class="fas fa-save"></i> Upload</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    <div th:replace="~{fragments/scripts :: scripts}"></div>
    <link th:href="@{/css/library.css}" rel="stylesheet">
    <script th:src="@{/js/library.js}"></script>
</body>
</html>